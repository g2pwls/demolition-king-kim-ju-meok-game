# 1ë‹¨ê³„: Node.js ê¸°ë°˜ ë¹Œë“œ í™˜ê²½
FROM node:20 AS build

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ì˜ì¡´ì„± ì„¤ì¹˜ë¥¼ ìœ„í•´ package íŒŒì¼ ë³µì‚¬
COPY package*.json ./

# ë¶ˆí•„ìš”í•œ ìºì‹œ ì œê±° í›„ ê¹¨ë—í•œ ì„¤ì¹˜
RUN rm -rf node_modules package-lock.json && npm install

# ì „ì²´ ì†ŒìŠ¤ ë³µì‚¬
COPY . .

# ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ (Vite, Rollup ê´€ë ¨)
RUN chmod -R +x node_modules/.bin

# ğŸ”§ ë„¤ì´í‹°ë¸Œ ëª¨ë“ˆ ê´€ë ¨ ì˜¤ë¥˜ ë°©ì§€
RUN npm rebuild

# ì•± ë¹Œë“œ
RUN npm run build --unsafe-perm

# 2ë‹¨ê³„: Nginx ê²½ëŸ‰ ì´ë¯¸ì§€ë¡œ ì •ì  íŒŒì¼ ì„œë¹™
FROM nginx:alpine

# ë¹Œë“œëœ ì •ì  íŒŒì¼ ë³µì‚¬
COPY --from=build /app/dist /usr/share/nginx/html

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 80

# Nginx ì‹¤í–‰
CMD ["nginx", "-g", "daemon off;"]